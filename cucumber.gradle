import net.masterthought.cucumber.ReportBuilder
import net.masterthought.cucumber.Configuration
import org.apache.tools.ant.taskdefs.condition.Os

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "net.masterthought:cucumber-reporting:3.19.0"
    }
}

task cucumber {
    dependsOn assemble, compileTestGroovy, getGeckoDriver, getChromeDriver, getOperaDriver, getPhantomJsDriver, getIExplorerDriver
    doLast {
        moveDriverFileToFolder()
        List<String> cucumberTags = parseTags()
        single(cucumberTags)
    }
}

String getDriversLocations(){
    switch (selectedBrowser){
        case "chrome":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "drivers/chromedriver.exe"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "drivers/chromedriver"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "drivers/chromedriver"
            }
            break
        case "firefox":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "drivers/geckodriver.exe"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "drivers/geckodriver"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "drivers/geckodriver"
            }
            break
        case "iexplorer":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "drivers/IEDriverServer.exe"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "drivers/gec"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "drivers/gec"
            }
            break
        case "opera":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "drivers/operadriver"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "drivers/operadriver"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "drivers/operadriver"
            }
            break
        case "phantomjs":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "drivers/phantomjs.exe"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "drivers/phantomjs"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "drivers/phantomjs"
            }
            break
        case "safari":
            if (Os.isFamily(Os.FAMILY_WINDOWS)) {
                return "/usr/bin/safaridriver"
            } else if (Os.isFamily(Os.FAMILY_MAC)) {
                return "/usr/bin/safaridriver"
            } else if (Os.isFamily(Os.FAMILY_UNIX)) {
                return "/usr/bin/safaridriver"
            }
            break
    }
}

String getDriversProperty(){
    switch (selectedBrowser){
        case "chrome":
            return 'webdriver.chrome.driver'
            break
        case "firefox":
            return 'webdriver.gecko.driver'
            break
        case "iexplorer":
            return 'webdriver.ie.driver'
            break
        case "opera":
            return 'webdriver.opera.driver'
            break
        case "phantomjs":
            return 'webdriver.phantomjs.driver'
            break
        case "safari":
            return 'webdriver.safari.driver'
            break
    }
}

void moveDriverFileToFolder(){
    if (((selectedBrowser != '') && !file(getDriversLocations()).exists()) && (extractDir != '')) {
        println "Moving the driver file!"
        ant.move file: extractDir, todir: "drivers/"
    }
}

void single(List<String> cucumberTags) {
    lunchCucumberCli(cucumberTags)
    generateReport()
}

void lunchCucumberCli(List<String> cucumberTags) {
    println "Running the tests!!"
    List<String> cucumberArgs = []
    cucumberArgs = ['--plugin', 'pretty', '--plugin', "json:${reporting.baseDir}/${selectedBrowser}.json",
                    '--plugin', "html:${reporting.baseDir}/cucumber-html-report-1", '--glue',
                    'src/cucumber/', 'src/test/groovy/', 'src/test/resources/', 'src/cucumber/features']
    cucumberArgs.addAll(cucumberTags)
    try {
        javaexec {
            println getDriversProperty() + getDriversLocations()
            systemProperty getDriversProperty(), getDriversLocations()
            jvmArgs = ["-Dgeb.env=${selectedBrowser}"]
            main = "cucumber.api.cli.Main"
            classpath = sourceSets.test.runtimeClasspath + sourceSets.main.runtimeClasspath
            args = cucumberArgs
        }
    }
    catch (Exception e) {
    }
}

List<String> parseTags() {
    List<String> result = []
    if (project.hasProperty('tags')) {
        project.tags.replace(' ', '').split('&').each {
            result << '--tags '
            result << it.replace('|', ',')
        }
    } else {
        println "No tags. Running for all!"
    }
    result << '--tags '
    result << '~@ignore'
    return result
}

def generateReport() {
    println "Tests completed. Generating report...."
    File reportOutputDirectory = new File("${reporting.baseDir}/")
    def jsonReports = fileTree(dir: "${reporting.baseDir}/").include '**.json'.toString()
    List<String> jsonReportFiles = new ArrayList<String>()
    jsonReports.each { File file ->
        jsonReportFiles.add("${reporting.baseDir}/${file.name}".toString())
    }
    String title = "Basic Web Automation Report"
    Configuration configuration = new net.masterthought.cucumber.Configuration(reportOutputDirectory, title)
    configuration.setParallelTesting(true)
    configuration.setRunWithJenkins(false)
    configuration.setBuildNumber("1")
    ReportBuilder reportBuilder = new ReportBuilder(jsonReportFiles, configuration)
    reportBuilder.generateReports()
}